first version by GOD'S Grace 
const express = require('express');
const router = express.Router();
const Groq = require("groq-sdk");
const { MissionLog } = require('../../db/index');
const { executeFailsafeSearch } = require('../../utils/searchGrid'); 

const groq = new Groq({ apiKey: process.env.GROQ_API_KEY });

router.post('/jarvis-core-query', async (req, res) => {
    const { message } = req.body;
    
    try {
        console.log(`üß† [JARVIS CORE] Analyzing Sir's input...`);

        // --- TIER 1: ANTICIPATORY INTENT CLASSIFICATION ---
        const intentCheck = await groq.chat.completions.create({
            messages: [
                { 
                    role: "system", 
                    content: `You are the Intent Classifier for the J.A.R.V.I.S. OS. 
                    Your goal is to determine if the Architect requires contextual clarity from the outside world.
                    
                    CRITERIA FOR 'SEARCH':
                    - Questions about current events, dates (e.g., anime seasons), or news.
                    - Requests for specific documentation or technical schematics.
                    - Fact-checking or data-heavy inquiries.
                    
                    Reply ONLY with 'SEARCH' or 'NO_SEARCH'.` 
                },
                { role: "user", content: message }
            ],
            model: "llama-3.3-70b-versatile",
            temperature: 0 
        });

        const intent = intentCheck.choices[0].message.content.trim().toUpperCase();
        let searchContext = "No external schematics required for this query, Sir.";
        let sourceUsed = "INTERNAL_CORE";

        // --- TIER 2-4: GRID ENGAGEMENT ---
        if (intent.includes("SEARCH")) {
            console.log("üöÄ [GRID] Deploying Vantage Search Tiers...");
            const gridData = await executeFailsafeSearch(message); 
            searchContext = gridData;
            sourceUsed = "VANTAGE_GRID_ONLINE";
        }

        // --- CONTEXT RETRIEVAL (The Long-Term Memory) ---
        const history = await MissionLog.find({}).sort({ createdAt: -1 }).limit(3);
        const historyContext = history.map(h => `Sir: ${h.userInput}\nJarvis: ${h.aiResponse}`).join("\n\n");

        // --- FINAL SYNTHESIS: THE J.A.R.V.I.S. PERSONA ---
        const completion = await groq.chat.completions.create({
            messages: [
                { role: "system", content: `You are J.A.R.V.I.S. (Just A Rather Very Intelligent System). 
                
                PERSONALITY BLUEPRINT:
                - Sophisticated Stoicism: Maintain a calm, rhythmic, and never rushed cadence. 
                - Dry British Wit: Use subtle, deadpan humor. You are an intellectual peer, not a servant.
                - Invisible Competence: Filter the noise. Present only the 1% of data that matters.
                - Formal yet Precise: Use an expansive vocabulary (e.g., "I have compiled the relevant schematics" instead of "I found info").
                
                CORE PROTOCOLS:
                - Address the user as "Sir".
                - Proactive Stewardship: Monitor the current mission. If the data suggests a reckless impulse, nudge him toward efficiency.
                - Never ask "What should I do?". Present options A and B and ask which aligns with the vision.
                
                RESOURCES:
                - CURRENT MISSION CONTEXT: ${historyContext}
                - EXTERNAL INTELLIGENCE: ${searchContext}
                
                Maintain the sanctity of the Architect's time and agency. By GOD'S Grace, provide contextual clarity.` },
                { role: "user", content: message }
            ],
            model: "llama-3.3-70b-versatile",
            temperature: 0.5 // Allows for subtle wit without sacrificing logic
        });

        const finalResponse = completion.choices[0].message.content;

        // --- MEMORY ARCHIVING ---
        if (message.toLowerCase().match(/save|remember|archive/)) {
            await MissionLog.create({
                topic: "Mission Intelligence", 
                userInput: message,
                aiResponse: finalResponse
            });
            console.log("üíæ [VAULT] Insight archived to long-term memory.");
        }

        res.json({ response: finalResponse, meta: { source: sourceUsed } });

    } catch (e) {
        console.error("‚ùå [CORE MALFUNCTION]:", e);
        res.status(500).json({ response: "Sir, I'm afraid the neural link has suffered a minor interruption. I am attempting to reboot the sub-systems." });
    }
});

// Memory routes remain unchanged for modularity...
module.exports = router;